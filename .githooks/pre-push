#!/bin/bash
# Pre-push hook for comprehensive MATLAB quality checks
#
# This hook runs before pushing to remote repository to ensure code quality.
# It performs comprehensive MATLAB quality checks using the matlab_utilities package.
#
# Installation:
#   cp .githooks/pre-push .git/hooks/pre-push
#   chmod +x .git/hooks/pre-push
#
# OR configure git to use .githooks directory:
#   git config core.hooksPath .githooks

set -e  # Exit on error

echo ""
echo "========================================="
echo "Pre-Push Quality Checks"
echo "========================================="
echo ""

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track overall success
OVERALL_SUCCESS=true

# Check if MATLAB is available
if command -v matlab &> /dev/null; then
    echo "✓ MATLAB found - running comprehensive quality checks..."
    echo ""

    # Run MATLAB quality checks
    echo "Running MATLAB Code Analyzer (mlint)..."

    MATLAB_EXIT_CODE=0
    matlab -batch "addpath('matlab_utilities/quality'); results = run_quality_checks('.', 'OutputFile', 'pre-push-quality.csv', 'Verbose', true); exit(~results.passed);" || MATLAB_EXIT_CODE=$?

    if [ $MATLAB_EXIT_CODE -ne 0 ]; then
        echo ""
        echo -e "${RED}❌ MATLAB quality checks FAILED!${NC}"
        echo ""
        echo "Issues have been saved to: pre-push-quality.csv"
        echo "Please review and fix the issues before pushing."
        echo ""
        echo "To bypass this check (not recommended):"
        echo "  git push --no-verify"
        echo ""
        OVERALL_SUCCESS=false
    else
        echo ""
        echo -e "${GREEN}✅ MATLAB quality checks PASSED!${NC}"
        echo ""
    fi
else
    echo -e "${YELLOW}⚠️  MATLAB not found - skipping full quality checks${NC}"
    echo "Running Python static analysis instead..."
    echo ""

    # Run Python static analyzer as fallback
    PYTHON_EXIT_CODE=0
    python matlab_utilities/scripts/matlab_quality_check.py || PYTHON_EXIT_CODE=$?

    if [ $PYTHON_EXIT_CODE -ne 0 ]; then
        echo ""
        echo -e "${RED}❌ Python static analysis FAILED!${NC}"
        echo "Please fix the issues before pushing."
        echo ""
        OVERALL_SUCCESS=false
    else
        echo ""
        echo -e "${GREEN}✅ Python static analysis PASSED!${NC}"
        echo ""
    fi
fi

# Final status
echo "========================================="
if [ "$OVERALL_SUCCESS" = true ]; then
    echo -e "${GREEN}✅ All pre-push checks PASSED${NC}"
    echo "========================================="
    echo ""
    exit 0
else
    echo -e "${RED}❌ Pre-push checks FAILED${NC}"
    echo "========================================="
    echo ""
    echo "To push anyway (NOT recommended):"
    echo "  git push --no-verify"
    echo ""
    exit 1
fi
